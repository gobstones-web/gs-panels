<link rel="import" href="gs-panel-simple.html">
<link rel="import" href="gs-panel-resize.html">
<link rel="import" href="gs-rezisable.html">
<link rel="import" href="gs-events.html">
<link rel="import" href="../../../gs-common/dist/components/dom-inject.html">
<dom-module id="gs-panel-composite">
  <template>
    <style>
      :host {
        background-color: #BBF;
        display: block;
        float: left;
        width: 100%;
        position: relative;
        box-sizing: border-box;
      }
      :host.not-last.child-of-vertical {
        padding-bottom: 7px;
      }
      :host.not-last.child-of-horizontal {
        padding-right: 7px;
      }

    </style>

    <template is="dom-if" if="{{notLast}}">
      <gs-panel-resize class$="{{parentOrientation}}"></gs-panel-resize>
    </template>
    <template is="dom-repeat" items="{{children}}" as="child">
      <template is="dom-inject" element="{{child}}"></template>
    </template>
  </template>
  <script>
    Polymer({
      is: 'gs-panel-composite',
      MIN_WIDTH: 150,
      properties: {
        children: {
          type: Array
        },
        panelHeight: {
          type: Number,
          value: 0
        },
        orientation: {
          type: String
        }
      },
      behaviors: [GS.Rezisable],
      observers: ['_update(children.*, panelHeight)'],
      listeners: (function() {
        var listeners;
        listeners = {};
        listeners[GS.EVENTS.CHILD_RESIZE_BEGIN] = '__forward_child_resize_begin';
        listeners[GS.EVENTS.CHILD_RESIZE] = '__forward_child_resize';
        listeners[GS.EVENTS.CHILD_RESIZE_FINISH] = '__forward_child_resize_finish';
        return listeners;
      })(),
      __forward_child_resize_begin: function(evnt) {
        evnt.cancelBubble = true;
        return this.__child_resize_begin(evnt.detail.context, evnt.detail.position);
      },
      __forward_child_resize: function(evnt) {
        evnt.cancelBubble = true;
        return this.__child_resize(evnt.detail.context, evnt.detail.position);
      },
      __forward_child_resize_finish: function(evnt) {
        evnt.cancelBubble = true;
        return this.__child_resize_finish(evnt.detail.context, evnt.detail.position);
      },
      ready: function() {
        this.children = [];
        this.orientation = this.orientation || GS.HORIZONTAL;
        this.classList.add(this.orientation);
        return this.extend(this, this.flow_strategies[this.orientation]);
      },
      _update: function() {
        var child, index, last_index, _i, _len, _ref, _results;
        if (this.children.length > 0) {
          this.style.height = this.panelHeight + 'px';
        } else {
          this.style.height = 'none';
        }
        last_index = this.children.length - 1;
        _ref = this.children;
        _results = [];
        for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
          child = _ref[index];
          child.index = index;
          child.panelHeight = this.panelHeight;
          _results.push(child.notLast = index !== last_index);
        }
        return _results;
      },
      add: function(element) {
        var next;
        next = document.createElement('gs-panel-simple');
        next.resize_data = {};
        next.concretElement = element;
        next.parentOrientation = this.orientation;
        this._after_push(next, 0);
        return this.push('children', next);
      },
      parse_percent_width: function(child) {
        return this.parse_percent(child.style.width);
      },
      __set_width_percent: function(child, percent) {
        child.style.width = percent + '%';
        return child.resize_data.width = this.parse_percent_width(child);
      },
      flow_strategies: {
        horizontal: {
          _after_push: function(element) {
            var amount, average, child, count, last_width, _i, _len, _ref;
            amount = this.children.length + 1;
            count = 0;
            average = 100 / amount;
            _ref = this.children;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              child = _ref[_i];
              this.__set_width_percent(child, average);
              count += child.resize_data.width;
            }
            last_width = 100 - count;
            return this.__set_width_percent(element, last_width);
          },
          __child_resize_begin: function(context, position) {
            var next_item;
            context.initial_mouse_x = position.clientX;
            context.initial_width = context.item.clientWidth;
            context.initial_width_percent = this.parse_percent(context.item.style.width);
            next_item = this.children[context.item.index + 1];
            context.max_width = context.item.clientWidth + next_item.clientWidth - this.MIN_WIDTH;
            return context.item.style.transition = 'none';
          },
          __fix_width_against: function(fix_item) {
            var child, count, _i, _len, _ref;
            count = 0;
            _ref = this.children;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              child = _ref[_i];
              if (child === fix_item) {
                continue;
              }
              count += child.resize_data.width;
            }
            return this.__set_width_percent(fix_item, 100 - count);
          },
          __child_resize: function(context, position) {
            var next_percent, next_px, width, x_delta;
            width = this.clientWidth;
            x_delta = position.clientX - context.initial_mouse_x;
            next_px = context.initial_width + x_delta;
            if (next_px > context.max_width) {
              next_px = context.max_width;
            }
            if (next_px < this.MIN_WIDTH) {
              next_px = this.MIN_WIDTH;
            }
            next_percent = context.initial_width_percent * next_px / context.initial_width;
            this.__set_width_percent(context.item, next_percent);
            return this.__fix_width_against(this.children[context.item.index + 1], context.item);
          },
          __child_resize_finish: function(context, position) {
            return context.item.style.transition = '0.5s';
          }
        },
        vertical: {
          _after_push: function(element) {}
        }
      }
    });

  </script>
</dom-module>